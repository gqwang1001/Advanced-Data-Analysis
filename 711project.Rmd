---
title: "The effects of gas prices on traffic fatalites among young adults in the US"
author: "Guoqing Wang"
output: html_document
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
# install.packages("foreign")
# install.packages("downloader")
# install.packages("utils")
# install.packages("readr")
# install.packages("xts")
# install.packages("readxl")
library(foreign)
library(downloader)
library(utils)
library(readr)
library(ggplot2)
library(xts)
library(readxl)
library(lubridate)
library(reshape)
setwd("/Users/guoqingwang/OneDrive - Johns Hopkins University/Coursework/dataananlysis/project/711project")
yearlist =2003:2015
accident = vector("list",length(yearlist))
names(accident) = as.character(yearlist)
year_names = as.character(yearlist)
```

## Introduction

The increasing gas price can lead to a decreasing trend of motor vehice fatalities. In general, higher prices lead to fewer miles driven, and lead to fewer chance for crash involvement and fewer fatalites. The aim of this analysis is to examine and estimate the relationship between fatal crashes and gas price. The data used in this research is obtained from the Fatality Analysis Reporting System of the National Highway Traffic Safety Administration. We are focusing on the year range from 1999 to 2008. The Annual average regular grade unleaded gasoline proces were obtained from Energy Information Administration (EIA), U.S. Department of Energy, which again will be focused on the year from 1999-2008. It may be reasonable to suppose the gasonline prices trend to be influenced by demand, as a price increase due to a higher demand for gasoline, which is a consequence of more miles driven and leads to higher fatalities. We therefore incorporate the demand of gasonline as a factor to estimate the price-fatality relationship. The data on the demond of gasonline is provided by the Energy Information Administration (EIA), U.S. Department of Energy. 

```{r download data,eval=F}
for(i in 1:length(yearlist)){
  if (yearlist[i]<2012){
    fileurl = paste0("ftp://ftp.nhtsa.dot.gov/fars/",yearlist[i],"/DBF/FARS",yearlist[i],".zip")
    destdir = paste0("../FARS",yearlist[i],".zip")
  }else if (yearlist[i] == 2012){
    fileurl = paste0("ftp://ftp.nhtsa.dot.gov/fars/",yearlist[i],"/National/DBF/FARS",yearlist[i],".zip")
    destdir = paste0("../FARS",yearlist[i],".zip")
  }else{
    fileurl = paste0("ftp://ftp.nhtsa.dot.gov/fars/", yearlist[i],
                "/National/FARS",yearlist[i],"NationalDBF.zip")
    destdir = paste0("../FARS",yearlist[i],"NationalDBF.zip")
  }
  
  download.file(fileurl,destfile = destdir, method = "curl")
  unzip(destdir,exdir = paste0("../data",yearlist[i]))
}
gasurl = "https://www.eia.gov/dnav/pet/xls/PET_PRI_GND_DCUS_NUS_W.xls"
gasdemand = "https://www.eia.gov/dnav/pet/hist_xls/A103600001m.xls"
download.file(gasurl,destfile = paste0(getwd(),"/weeklygas.xls"),method = "curl")
download.file(gasdemand,destfile = paste0(getwd(),"/gasdemand.xls"),method = "curl")
```


```{r exploratary}
for(i in 1:length(yearlist)){
accident1 = read.dbf(paste0("../data", yearlist[i],"/accident.dbf"))
accident[[i]] = accident1
}

count = c()
for(i in 1:length(yearlist)){
acc = accident[[year_names[i]]]
acc$date = as.Date(with(acc, paste(YEAR, MONTH, DAY,sep="-")), "%Y-%m-%d")
acc$weeknum = week(ymd(acc$date))
weeklyfatal = aggregate(acc$FATALS, by=list(weeknum = acc$weeknum),FUN = sum)
count = cbind(count,weeklyfatal$x)
}
count = count[-53,]
n_month = 52
accci_count = data.frame(year = rep(yearlist,each = n_month), week = rep(1:n_month,times = length(yearlist)), weekcount = rep(1:(n_month*length(yearlist))), num_fatal = as.vector(count))

ggplot(data = accci_count,aes(week,num_fatal))+geom_smooth(aes(group = year,colour = as.factor(year))) +xlab("Week")+ylab("Number of Fatality")


gas_price = read_excel("weeklygas.xls",sheet = 2,skip = 2)

gp = data.frame(Date = as.Date(gas_price$Date),regulargas = gas_price$`Weekly U.S. Regular All Formulations Retail Gasoline Prices  (Dollars per Gallon)`)
ggplot(data = gp,aes(Date,regulargas))+geom_line()

#extract data from 1999-2008
gp1 = gp[gp$Date>="1999-01-01"& gp$Date<"2009-01-01",]
```

```{r get the gas demand data}
library(readxl)
if(!file.exists("../gasdemand")){
  dir.create("../gasdemand")
}
# monthly: the effect of gas demand on predicting the traffic fatality within certain state.
State = c('AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY')
for(i in 1:length(State)){
  gasurldemand = paste0("http://www.eia.gov/dnav/pet/xls/PET_CONS_REFMG_D_S",State[i],"_VTR_MGALPD_M.xls")
  destfileurl = paste0("../gasdemand/",State[i],".xls")
  download.file(gasurldemand,destfile = destfileurl,method = "curl")
  if(i==1){
    gasdmd = read_excel(path = destfileurl,sheet = 2, skip = 2)
  }else{
  temp = read_excel(path = destfileurl,sheet = 2, skip = 2)
  gasdmd = merge(gasdmd,temp,by="Date")
  }
}
colnames(gasdmd) = c("date", State)
colSums(is.na(gasdmd))
rowSums(is.na(gasdmd))
# remove states with more than 100 NA's
ind = which(colSums(is.na(gasdmd))<100)
state_left = State[ind-1]
state_time = which(rowSums(is.na(gasdmd))<15)
gasdmd1 = gasdmd[state_time,c("date",state_left)]
sum(is.na(gasdmd1))

gasdmd2 = melt(gasdmd1,id.vars = "date",variable_name = "States")

ggplot(data = gasdmd2, aes(date,value))+geom_line(aes(colour = States))


```

## Methods

We will try to develop the model to regress the fatality count on the gas demand and gas price. We employ the method of functional mixed effect model to analyze the the effect of gas demand on predictiing the fatality count within a certain month. 

$$
Y_i(t) = \alpha_i(t)+\int Gas_i(s)\beta(s,t) ds + V_i(t)\gamma(t)+ \epsilon_i(t)
$$

where $i$ is the state, $t$ is the time in months. The regression function for a fixed value of $t$ as the realitve weight placed on the temperture at month $s$ that is required to predict the precipitation. The function $\alpha_i(t)$ contributes the random effects on the level of state.

### Compare to the Generalized Linear Model approach

Most people analyzed the Gas price-fatality relation by using Generalized Linear Regression Model as follows:

$$
g(Y_{it}) = \beta_0 + \beta_1 Sp(t, df = n) + \beta_2 Gas_{it} + \beta_3 V_it
$$

where $g(\cdot)$ is a negative binomial link, $Sp(t,df=n)$ is a spline on time with degree $n$. 

## Result

## Discussion

